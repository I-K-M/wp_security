#!/bin/bash

LOGFILE="./scan-result.log"
exec > >(tee -a "$LOGFILE") 2>&1

echo '=== 🔍 wp full scan ==='
echo ''

echo '--- 📁 php files scan ---'
echo '🔍 wp-content/cache → eval('
grep -r --include='*.php' "eval(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → base64_decode('
grep -r --include='*.php' "base64_decode(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → gzinflate('
grep -r --include='*.php' "gzinflate(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → gzuncompress('
grep -r --include='*.php' "gzuncompress(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → str_rot13('
grep -r --include='*.php' "str_rot13(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → shell_exec('
grep -r --include='*.php' "shell_exec(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → exec('
grep -r --include='*.php' "exec(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → passthru('
grep -r --include='*.php' "passthru(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → system('
grep -r --include='*.php' "system(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → assert('
grep -r --include='*.php' "assert(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → preg_replace('
grep -r --include='*.php' "preg_replace(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → create_function('
grep -r --include='*.php' "create_function(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → file_put_contents('
grep -r --include='*.php' "file_put_contents(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → curl_exec('
grep -r --include='*.php' "curl_exec(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → popen('
grep -r --include='*.php' "popen(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → proc_open('
grep -r --include='*.php' "proc_open(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → fopen('
grep -r --include='*.php' "fopen(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/cache → php_uname('
grep -r --include='*.php' "php_uname(" wp-content/cache 2>/dev/null
echo '🔍 wp-content/uploads → eval('
grep -r --include='*.php' "eval(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → base64_decode('
grep -r --include='*.php' "base64_decode(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → gzinflate('
grep -r --include='*.php' "gzinflate(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → gzuncompress('
grep -r --include='*.php' "gzuncompress(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → str_rot13('
grep -r --include='*.php' "str_rot13(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → shell_exec('
grep -r --include='*.php' "shell_exec(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → exec('
grep -r --include='*.php' "exec(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → passthru('
grep -r --include='*.php' "passthru(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → system('
grep -r --include='*.php' "system(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → assert('
grep -r --include='*.php' "assert(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → preg_replace('
grep -r --include='*.php' "preg_replace(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → create_function('
grep -r --include='*.php' "create_function(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → file_put_contents('
grep -r --include='*.php' "file_put_contents(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → curl_exec('
grep -r --include='*.php' "curl_exec(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → popen('
grep -r --include='*.php' "popen(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → proc_open('
grep -r --include='*.php' "proc_open(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → fopen('
grep -r --include='*.php' "fopen(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/uploads → php_uname('
grep -r --include='*.php' "php_uname(" wp-content/uploads 2>/dev/null
echo '🔍 wp-content/plugins → eval('
grep -r --include='*.php' "eval(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → base64_decode('
grep -r --include='*.php' "base64_decode(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → gzinflate('
grep -r --include='*.php' "gzinflate(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → gzuncompress('
grep -r --include='*.php' "gzuncompress(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → str_rot13('
grep -r --include='*.php' "str_rot13(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → shell_exec('
grep -r --include='*.php' "shell_exec(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → exec('
grep -r --include='*.php' "exec(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → passthru('
grep -r --include='*.php' "passthru(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → system('
grep -r --include='*.php' "system(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → assert('
grep -r --include='*.php' "assert(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → preg_replace('
grep -r --include='*.php' "preg_replace(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → create_function('
grep -r --include='*.php' "create_function(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → file_put_contents('
grep -r --include='*.php' "file_put_contents(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → curl_exec('
grep -r --include='*.php' "curl_exec(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → popen('
grep -r --include='*.php' "popen(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → proc_open('
grep -r --include='*.php' "proc_open(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → fopen('
grep -r --include='*.php' "fopen(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/plugins → php_uname('
grep -r --include='*.php' "php_uname(" wp-content/plugins 2>/dev/null
echo '🔍 wp-content/themes → eval('
grep -r --include='*.php' "eval(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → base64_decode('
grep -r --include='*.php' "base64_decode(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → gzinflate('
grep -r --include='*.php' "gzinflate(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → gzuncompress('
grep -r --include='*.php' "gzuncompress(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → str_rot13('
grep -r --include='*.php' "str_rot13(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → shell_exec('
grep -r --include='*.php' "shell_exec(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → exec('
grep -r --include='*.php' "exec(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → passthru('
grep -r --include='*.php' "passthru(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → system('
grep -r --include='*.php' "system(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → assert('
grep -r --include='*.php' "assert(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → preg_replace('
grep -r --include='*.php' "preg_replace(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → create_function('
grep -r --include='*.php' "create_function(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → file_put_contents('
grep -r --include='*.php' "file_put_contents(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → curl_exec('
grep -r --include='*.php' "curl_exec(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → popen('
grep -r --include='*.php' "popen(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → proc_open('
grep -r --include='*.php' "proc_open(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → fopen('
grep -r --include='*.php' "fopen(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/themes → php_uname('
grep -r --include='*.php' "php_uname(" wp-content/themes 2>/dev/null
echo '🔍 wp-content/mu-plugins → eval('
grep -r --include='*.php' "eval(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → base64_decode('
grep -r --include='*.php' "base64_decode(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → gzinflate('
grep -r --include='*.php' "gzinflate(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → gzuncompress('
grep -r --include='*.php' "gzuncompress(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → str_rot13('
grep -r --include='*.php' "str_rot13(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → shell_exec('
grep -r --include='*.php' "shell_exec(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → exec('
grep -r --include='*.php' "exec(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → passthru('
grep -r --include='*.php' "passthru(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → system('
grep -r --include='*.php' "system(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → assert('
grep -r --include='*.php' "assert(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → preg_replace('
grep -r --include='*.php' "preg_replace(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → create_function('
grep -r --include='*.php' "create_function(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → file_put_contents('
grep -r --include='*.php' "file_put_contents(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → curl_exec('
grep -r --include='*.php' "curl_exec(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → popen('
grep -r --include='*.php' "popen(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → proc_open('
grep -r --include='*.php' "proc_open(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → fopen('
grep -r --include='*.php' "fopen(" wp-content/mu-plugins 2>/dev/null
echo '🔍 wp-content/mu-plugins → php_uname('
grep -r --include='*.php' "php_uname(" wp-content/mu-plugins 2>/dev/null

echo ''
echo '--- 🧠 db scan ---'
echo ''
# change ids
DB_NAME='name'
DB_USER='user'
DB_PASS='password'
DB_HOST='localhost'

SQL_TEMP=$(mktemp)
cat <<'EOF' > "$SQL_TEMP"
-- wp_options w base64
SELECT 'wp_options' AS context, option_name, option_value 
FROM wp_options 
WHERE option_value LIKE '%base64%';

-- wp_posts w <script
SELECT 'wp_posts' AS context, post_title, post_content 
FROM wp_posts 
WHERE post_content LIKE '%<script%';

-- cron
SELECT 'wp_options (cron)' AS context, option_name, option_value 
FROM wp_options 
WHERE option_name = 'cron';

-- transients w eval
SELECT 'transients eval' AS context, option_name, option_value 
FROM wp_options 
WHERE option_name LIKE '_transient%' AND option_value LIKE '%eval%';

-- transients w malicious patterns
SELECT 'transients (dangerous)' AS context, option_name, option_value 
FROM wp_options 
WHERE option_name LIKE '_transient%' AND (
  option_value LIKE '%base64%' OR 
  option_value LIKE '%gzinflate%' OR 
  option_value LIKE '%gzuncompress%' OR 
  option_value LIKE '%str_rot13%' OR 
  option_value LIKE '%eval%' OR 
  option_value LIKE '%preg_replace%' OR
  option_value LIKE '%shell_exec%' OR
  option_value LIKE '%assert(%'
);

-- autoload
SELECT 'wp_options (autoload size)' AS context, option_name, LENGTH(option_value) AS size 
FROM wp_options 
WHERE autoload = 'yes' 
ORDER BY size DESC 
LIMIT 50;

-- users
SELECT 'wp_users' AS context, ID, user_login, user_email, user_registered, user_status, display_name
FROM wp_users;

-- user capabilities
SELECT 'wp_usermeta (capabilities)' AS context, user_id, meta_key, meta_value
FROM wp_usermeta 
WHERE meta_key LIKE '%capabilities%';
EOF

mysql -u "$DB_USER" -p"$DB_PASS" -h "$DB_HOST" "$DB_NAME" < "$SQL_TEMP" | tee -a "$LOGFILE"
rm "$SQL_TEMP"
echo ''
echo "✅ scan completed: see results in $LOGFILE"